#!/usr/bin/env bash

JUJU_HOME=$1
[ -n $JUJU_HOME ] && JUJU_HOME=~/.juju
JUJU_REPO=https://bitbucket.org/fsquillace/juju-repo/raw/master
JUJU_BIN=$(dirname "$0")
ORIGIN_WD=$(pwd)


function setup_juju(){
    trap - QUIT EXIT ABRT KILL TERM INT
    trap "rm -rf ${maindir}; die \"Error occurred when installing $pkggrp\"" EXIT QUIT ABRT KILL TERM INT

    maindir=$(TMPDIR=/tmp mktemp -d -t juju.XXXXXXXXXX)
    builtin cd ${maindir}

    info "Downloading JuJu..."
    imagefile=juju-$(uname -m).tar.gz
    wget ${JUJU_REPO}/$imagefile
    tar -zxpf $imagefile

    info "Installing JuJu..."
    mkdir -p $JUJU_HOME
    cp -f -a ${maindir}/juju/* $JUJU_HOME
    info "JuJu installed successfully"

    builtin cd $ORIGIN_WD
    trap - QUIT EXIT ABRT KILL TERM INT
}


function run_juju(){
    ${JUJU_BIN}/arch-chroot $JUJU_HOME
}


echoerr() { echo "$@" 1>&2; }
function die(){
# $@: msg (mandatory) - str: Message to print
    error $@
    exit 1
}
function error(){
# $@: msg (mandatory) - str: Message to print
    echoerr -e "\033[1;31m$@\033[0m"
}
function warn(){
# $@: msg (mandatory) - str: Message to print
    echoerr -e "\033[1;33m$@\033[0m"
}
function info(){
# $@: msg (mandatory) - str: Message to print
    echo -e "\033[1;37m$@\033[0m"
}

if [ ! "$(ls -A $JUJU_HOME)" ]
then
    setup_juju
fi

run_juju


